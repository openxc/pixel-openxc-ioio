#!/bin/bash

if [ $# -ne 2 ]; then
  echo "Usage: make-firmware-release devboot-ver app-ver"
  exit 1
fi

DEVBOOT_VER=$1
APP_VER=$2

# Which configuratiosn to use for the device bootloader.
DEVBOOT_CONFIGS=(PIXL0020)
# Which app configuration to associate with each device bootloader configuration.
DEVBOOT_APP_CONFIGS=(IOIO0030)

# Which configurations to use for the app.
APP_CONFIGS=(IOIO0030)

TEMPDIR=$(mktemp -dt dist.XXXXXX)

if [ ! -f release/firmware/device-bootloader/DevBoot-$DEVBOOT_VER.zip ]; then
  echo 'Building device-bootloader-only bundles.'
  mkdir -p release/firmware/device-bootloader
  tools/make-ioio-bundle firmware/device_bootloader/dist release/firmware/device-bootloader/DevBoot-$DEVBOOT_VER.ioioimg ${DEVBOOT_CONFIGS[@]}
  tools/make-hex-bundle firmware/device_bootloader/dist release/firmware/device-bootloader/DevBoot-$DEVBOOT_VER.zip ${DEVBOOT_CONFIGS[@]}
else
  echo 'Using existing device bootloader images'
fi
unzip release/firmware/device-bootloader/DevBoot-$DEVBOOT_VER.zip -d $TEMPDIR/DevBoot

echo 'Building app-only bundles.'
mkdir -p release/firmware/application
tools/make-ioio-bundle firmware/app_layer_v1/dist release/firmware/application/App-$APP_VER.ioioapp ${APP_CONFIGS[@]}

echo 'Building device-bootloader + app bundles.'

for ((i = 0; i < ${#DEVBOOT_CONFIGS[@]}; ++i)); do
  DEVBOOT_CONFIG=${DEVBOOT_CONFIGS[i]}
  APP_CONFIG=${DEVBOOT_APP_CONFIGS[i]}
  mkdir -p $TEMPDIR/$DEVBOOT_CONFIG/production
  tools/merge-hex $TEMPDIR/DevBoot/$DEVBOOT_CONFIG.hex firmware/app_layer_v1/dist/$APP_CONFIG/production/app_layer_v1.production.hex > $TEMPDIR/$DEVBOOT_CONFIG/production/merged.production.hex
done

tools/make-ioio-bundle $TEMPDIR release/firmware/device-bootloader/DevBoot-$DEVBOOT_VER-App-$APP_VER.ioioimg ${DEVBOOT_CONFIGS[@]}
tools/make-hex-bundle $TEMPDIR release/firmware/device-bootloader/DevBoot-$DEVBOOT_VER-App-$APP_VER.zip ${DEVBOOT_CONFIGS[@]}


